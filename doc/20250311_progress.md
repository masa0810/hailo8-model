# 2025-03-11 作業メモ

## これまでの状況整理
- `hailo parser` を用いた `src_models/deimv2_atto.onnx` → HAR 変換では、以下の未対応演算が原因で失敗していた。  
  `GridSample / GridSample_1`、`GatherElements`、`TopK`、`ReduceMax`(keepdims=0)、`Slice`（axis=4）、`Tile`（batch 軸）、`Mod`、`Reshape/Flatten` 由来の shuffle 系など。
- 参考情報を収集した結果、GridSample や TopK・GatherElements はホスト側処理（またはモデル構造の変更）で回避する事例が多く、ReduceMax は `keepdims=True` を要求される。

## 未対応演算に関する調査まとめ

| 演算 | SDK の現状 | モデル側での主な対処 | 参考リンク |
| --- | --- | --- | --- |
| GridSample | SDK 3.33 時点で未サポート。一般サポート予定なし。 | 動的ワープはホスト側で処理。固定ワープなら `Resize`/`Pad` などで置き換え可能。 | [Support for GridSample operation](https://community.hailo.ai/t/support-for-gridsample-operation/13957/2) |
| GatherElements | デバイス側未サポート。 | `torch.gather` を `index_select` 等へリライトして生成を避けるか、ホスト側実装に逃がす。 | [Parse Transformer Decoder](https://community.hailo.ai/t/parse-transformer-decoder/11480/2) |
| TopK | 未サポート。 | `k=1` は `ArgMax` へ変換。複数件はホスト側フィルタや CPU 後処理に分離。 | 同上 |
| ReduceMax | 特徴チャネル軸かつ `keepdims=True` のみサポート。 | ONNX 生成時に `keepdims=True` を設定し、必要なら `Squeeze` で整形。 | 同上 |
| Slice (axis>feature) | 特徴軸以外は未サポート。公開ワークアラウンド無し。 | 軸を入れ替える、またはホストで前処理。 | 公開情報無し |
| Tile (batch 軸) / Mod など | バッチ方向複製や剰余は未サポート。 | ホスト後処理へ切り出す、もしくはモデル構造変更。 | 公開情報無し |

## 実施内容（提案①の対応）
1. **Stage 分割自動化**  
   - `tools/prepare_stage_models.py` を追加。`deimv2_{variant}.onnx`（`variant ∈ {atto, femto, pico, n, s, x1, x2, x3}`）から  
     - **Stage1** : `src_models/deimv2_{variant}_stage1.onnx`（入力 `images` → 出力 `hailo_stage1_feat`）  
     - **Stage2** : `src_models/deimv2_{variant}_stage2.onnx`（入力 `hailo_stage1_feat` と `images` → 出力 `label_xyxy_score`）  
     を生成するよう共通化。`--check` オプションで ONNX Runtime による等価性検証（最大差分 0.0）を実施可能。
2. **ホスト側ランナー**  
   - `host/stage2_runner.py` を更新し、Stage1 の特徴テンソルに加えて元画像を与えることで Stage2 ONNX を CPU 上で推論できるようにした。
3. **Stage1 HAR 生成結果**  
   - `hailo parser` の結果は以下の通り（`dst_models/deimv2_{variant}_stage1.har` は `.gitignore` により未追跡）。  

| Variant | HAR 生成結果 | 備考 |
| --- | --- | --- |
| atto / femto / pico / n | ✅ 正常完了 | 既存フローと同様に `hailo_stage1_feat` のみをデバイス出力とする構成で問題なし |
| s / x1 / x2 / x3 | ⚠️ `ZeroDivisionError` (`ew_mult` 層の shape 判定時) | Hailo SDK 3.33 のバグとみられ、Stage1 でも NMS 周辺の要素が残る構造。要個別対応 |

   - 失敗したバリアントでも Stage1/Stage2 の ONNX 分割自体は成功しており、CPU 上での Stage2 後処理は確認済み。

これにより、Hailo 上では Stage1 を実行して特徴量を得るだけで良くなり、未対応演算はホスト CPU 側にオフロード可能となった。

## 次の検討事項
1. Stage1 HAR が失敗するバリアント（s/x1/x2/x3）について、Hailo SDK 側の Shape 推論バグ回避策を要確認（例：モデル側で該当 `Mul` ブロックを調整する／Hailo サポートへエラーレポートする）。
2. Stage1 HAR 成功済みのバリアントを実機評価し、リソース使用量やレイテンシを測定する。
3. Stage2 の ReduceMax（keepdims=0）のままでもホスト処理上は問題ないが、後段処理の都合で `keepdims=True` へ変換するか検討。
4. `Slice(axis=4)` や `Tile(batch)` をモデル構造側で除去できるか、更なるリファインを検討（例：Hailo Model Zoo に合わせたアーキテクチャへ置換）。
