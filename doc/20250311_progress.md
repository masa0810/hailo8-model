# 2025-03-11 作業メモ

## これまでの状況整理
- `hailo parser` を用いた `src_models/deimv2_atto.onnx` → HAR 変換では、以下の未対応演算が原因で失敗していた。  
  `GridSample / GridSample_1`、`GatherElements`、`TopK`、`ReduceMax`(keepdims=0)、`Slice`（axis=4）、`Tile`（batch 軸）、`Mod`、`Reshape/Flatten` 由来の shuffle 系など。
- 参考情報を収集した結果、GridSample や TopK・GatherElements はホスト側処理（またはモデル構造の変更）で回避する事例が多く、ReduceMax は `keepdims=True` を要求される。

## 未対応演算に関する調査まとめ

| 演算 | SDK の現状 | モデル側での主な対処 | 参考リンク |
| --- | --- | --- | --- |
| GridSample | SDK 3.33 時点で未サポート。一般サポート予定なし。 | 動的ワープはホスト側で処理。固定ワープなら `Resize`/`Pad` などで置き換え可能。 | [Support for GridSample operation](https://community.hailo.ai/t/support-for-gridsample-operation/13957/2) |
| GatherElements | デバイス側未サポート。 | `torch.gather` を `index_select` 等へリライトして生成を避けるか、ホスト側実装に逃がす。 | [Parse Transformer Decoder](https://community.hailo.ai/t/parse-transformer-decoder/11480/2) |
| TopK | 未サポート。 | `k=1` は `ArgMax` へ変換。複数件はホスト側フィルタや CPU 後処理に分離。 | 同上 |
| ReduceMax | 特徴チャネル軸かつ `keepdims=True` のみサポート。 | ONNX 生成時に `keepdims=True` を設定し、必要なら `Squeeze` で整形。 | 同上 |
| Slice (axis>feature) | 特徴軸以外は未サポート。公開ワークアラウンド無し。 | 軸を入れ替える、またはホストで前処理。 | 公開情報無し |
| Tile (batch 軸) / Mod など | バッチ方向複製や剰余は未サポート。 | ホスト後処理へ切り出す、もしくはモデル構造変更。 | 公開情報無し |

## 実施内容（提案①の対応）
1. **Stage 分割**  
   - `onnx.utils.extract_model` を用いて、元モデルを以下の 2 段に分割。  
     - **Stage1** : `src_models/deimv2_stage1.onnx`（入力 `images` → 出力 `hailo_stage1_feat`）。  
       - `hailo parser` により `dst_models/deimv2_stage1.har` を生成済み。  
       - 演算種類は `Conv`/`Pool`/`Concat`/`Reshape` 等のみで、未対応演算を含まない。  
     - **Stage2** : `src_models/deimv2_stage2.onnx`（入力 `hailo_stage1_feat` → 出力 `label_xyxy_score`）。  
       - GridSample / TopK / GatherElements / Tile 等はこのステージに集中し、ホスト側で実行する。
2. **整合性チェック**  
   - ONNX Runtime 上で `deimv2_atto.onnx` と Stage1+Stage2 を連結した推論結果を比較し、最大差分 `0.0` を確認。
3. **ホスト側ランナー**  
   - `host/stage2_runner.py` を追加。Stage1 の特徴テンソル（Numpy array）を受け取り、Stage2 ONNX を CPU で実行して最終検出結果を返すサンプル実装。

これにより、Hailo 上では Stage1 を実行して特徴量を得るだけで良くなり、未対応演算はホスト CPU 側にオフロード可能となった。

## 次の検討事項
1. Stage1 の HAR を実機で評価し、パフォーマンスやメモリ要件を計測する。
2. Stage2 の ReduceMax（keepdims=0）のままでもホスト処理上は問題ないが、精度や後段実装の都合で `keepdims=True` へ変換するか検討（必要なら ONNX 修正 & 追加の `Squeeze` を挿入）。
3. `Slice(axis=4)` や `Tile(batch)` をモデル構造側で除去できるか、更なるリファインを検討（例：Hailo Model Zoo に合わせたアーキテクチャへ置換）。
